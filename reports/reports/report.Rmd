---
title: "Informe técnico — M8 Reto 2"
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Detecta la carpeta del proyecto (si estás dentro de reports/, sube un nivel)
proj_dir <- normalizePath(if (basename(getwd()) == "reports") ".." else ".")

# Paquetes
pkgs <- c("dplyr","readr","ggplot2","knitr")
to_install <- setdiff(pkgs, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install, repos = "https://cloud.r-project.org")
library(dplyr); library(readr); library(ggplot2); library(knitr)

# Rutas de datos ABSOLUTAS respecto al proyecto
path_rds <- file.path(proj_dir, "data", "tfr_gapminder.rds")
path_csv <- file.path(proj_dir, "data", "tfr_gapminder.csv")

# Carga de datos
df <- NULL
if (file.exists(path_rds)) {
  df <- readRDS(path_rds)
} else if (file.exists(path_csv)) {
  df <- readr::read_csv(path_csv, show_col_types = FALSE)
}
```

## Objetivos

**Principal:** Analizar la evolución del TFR por país y detectar el cruce del umbral de reemplazo (≤ 2.1).

**Específicos:**
1) Depurar y documentar `tfr_gapminder.csv` y generar `tfr_gapminder.rds`.  
2) Describir tendencias por década y en el periodo reciente.  
3) Identificar el año de cruce del nivel de reemplazo y el % de países ≤ 2.1 en el último año.  
4) Comparar países en el último año (top/bottom y resumen).

## Datos
Fuente: Gapminder (TFR). Archivos esperados: `data/tfr_gapminder.csv` y/o `data/tfr_gapminder.rds`.

```{r, echo=FALSE}
if (is.null(df)) {
  cat("⚠️ No se encontraron datos. Ejecuta `scripts/01_load_clean.R` o verifica que existen los archivos en `data/`.\n")
} else {
  cat("✅ Datos cargados. Filas:", nrow(df), " — Columnas:", ncol(df), "\n")
}
```

## Tabla resumen (último año disponible)

```{r}
if (!is.null(df) && all(c("country","year","tfr") %in% names(df))) {
  ultimo <- max(df$year, na.rm = TRUE)
  tab <- df |>
    dplyr::filter(year == ultimo) |>
    dplyr::summarise(
      n_paises    = dplyr::n_distinct(country),
      mediana_tfr = median(tfr, na.rm = TRUE),
      q1          = quantile(tfr, 0.25, na.rm = TRUE),
      q3          = quantile(tfr, 0.75, na.rm = TRUE),
      pct_leq_2_1 = mean(tfr <= 2.1, na.rm = TRUE) * 100
    )
  knitr::kable(tab, digits = 2, caption = paste("Resumen — Año", ultimo))
} else {
  "⚠️ No se pudieron generar indicadores."
}
```

## Gráfico principal (mediana global)

```{r}
if (!is.null(df) && all(c("year","tfr") %in% names(df))) {
  serie_global <- df |>
    dplyr::group_by(year) |>
    dplyr::summarise(tfr_mediana = median(tfr, na.rm = TRUE), .groups = "drop")

  ggplot(serie_global, aes(year, tfr_mediana)) +
    geom_line() +
    geom_hline(yintercept = 2.1, linetype = "dashed") +
    labs(title = "Mediana global del TFR por año",
         x = "Año", y = "TFR (mediana)")
} else {
  plot(pressure, main = "Ejemplo (sin datos)", xlab = "x", ylab = "y")
}
```

## Reproducibilidad

1) Ejecutar `scripts/01_load_clean.R` para crear `data/tfr_gapminder.rds`.  
2) Knit este documento para generar `reports/report.html`.
